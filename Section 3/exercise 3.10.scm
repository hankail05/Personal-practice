#lang sicp
(define (make-withdraw initial-amount)
  (let ((balance initial-amount))
    (lambda (amount)
      (if (>= balance amount)
          (begin (set! balance (- balance amount))
                 balance)
          "Insufficient funds"))))

; (define W1 (make-withdraw 100))
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-withdraw:──────────────────────────────────────────────────────────────────┐                │
; global -> │                                                                                │                │
; env       │W1:───┐                                                                         │                │
;           └──────┼─────────────────────────────────────────────────────────────────────────┼────────────────┘
;                  │            ∧                                                            │  ∧
;                  │      ┌──────────────────┐                                               ∨  │
;                  │  E1->│initial-amount:100│                                               ◎◎─┘
;                  │      └──────────────────┘                                               ∨
;                  │            ∧                                                  parameter:initial-amount
;                  │      ┌──────────────────────┐                                 body:(lambda (balance) (
;                  │  E2->│balance:initial-amount│                                     ...)) initial-amount)
;                  │      └──────────────────────┘
;                  ∨            │
;                  ◎◎───────────┘
;                  ∨
;                  parameter:amount 
;                  body:(if (...))

; (W1 50)
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-withdraw:...                                                                                │
; global -> │                                                                                                 │
; env       │W1:───┐                                                                                          │
;           └──────┼──────────────────────────────────────────────────────────────────────────────────────────┘
;                  │            ∧
;                  │      ┌──────────────────┐
;                  │  E1->│initial-amount:100│
;                  │      └──────────────────┘
;                  │            ∧                                     
;                  │      ┌───────────┐
;                  │  E2->│balance:100│
;                  │      └───────────┘
;                  ∨            │   ∧
;                  ◎◎───────────┘  ┌──────────┐
;                  ∨           E3->│amount:100│
;           parameter:amount      └──────────┘
;           body:...                (if (...))

; After application
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-withdraw:...                                                                                │
; global -> │                                                                                                 │
; env       │W1:───┐                                                                                          │
;           └──────┼──────────────────────────────────────────────────────────────────────────────────────────┘
;                  │            ∧
;                  │      ┌──────────────────┐
;                  │  E1->│initial-amount:100│
;                  │      └──────────────────┘
;                  │            ∧                                     
;                  │      ┌──────────┐
;                  │  E2->│balance:50│
;                  │      └──────────┘
;                  ∨            │
;                  ◎◎───────────┘
;                  ∨
;                  parameter:amount
;                  body:...

; Do the same applications with W2
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-withdraw:...                                                                                │
; global -> │W2:──────────────────────────────────┐                                                           │
; env       │W1:───┐                              │                                                           │
;           └──────┼──────────────────────────────┼───────────────────────────────────────────────────────────┘
;                  │            ∧                 │            ∧
;                  │      ┌──────────────────┐    │      ┌──────────────────┐
;                  │  E1->│initial-amount:100│    │  E3->│initial-amount:100│
;                  │      └──────────────────┘    │      └──────────────────┘
;                  │            ∧                 │            ∧                                 
;                  │      ┌──────────┐            │      ┌──────────┐
;                  │  E2->│balance:50│            │  E4->│balance:50│
;                  │      └──────────┘            │      └──────────┘
;                  ∨            │                 ∨            │
;                  ◎◎───────────┘                 ◎◎───────────┘
;                  ∨                              │
;                  parameter:amount  <───────────┘
;                  body:...