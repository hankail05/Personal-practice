#lang sicp
(define (make-account balance)
  (define (withdraw amount)
    (if (>= balance amount)
        (begin (set! balance (- balance amount))
               balance)
        "Insufficient funds"))
  (define (deposit amount)
    (set! balance (+ balance amount))
    balance)
  (define (dispatch m)
    (cond ((eq? m 'withdraw) withdraw)
          ((eq? m 'deposit) deposit)
          (else (error "Unknown request -- MAKE-ACCOUNT"
                       m))))
  dispatch)

;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-account:───────────────────────────────────────────────────────────────────┐                │
; global -> │                                                                                │                │
; env       │                                                                                │                │
;           └────────────────────────────────────────────────────────────────────────────────┼────────────────┘
;                                                                                            │  ∧
;                                                                                            ∨  │
;                                                                                            ◎◎─┘
;                                                                                            ∨
;                                                                                   parameter:balance
;                                                                                   body:(define (...)
;                                                                                        dispatch)

; (define acc (make-account 50))
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-account:...                                                                                 │
; global -> │acc:───┐                                                                                         │
; env       │       │                                                                                         │
;           └───────┼─────────────────────────────────────────────────────────────────────────────────────────┘
;                   │                                              ∧
;                   │                ┌─────────────────────────────────────────────────────────┐
;                   │                │balance:50                                               │
;                   │                │withdraw:─────────────────────────────────────────────┐  │
;                   │          E1 -> │deposit:──────────────────────────┐                   │  │
;                   │                │dispatch:─┐                       │                   │  │
;                   │                └──────────┼───────────────────────┼───────────────────┼──┘
;                   │                  ∧        │  ∧                    │   ∧              │  ∧
;                   │  ┌───────────────┘        ◎◎─┘                    ◎◎─┘               ◎◎─┘  
;                   ∨  │                        ∨                       ∨                  ∨
;                   ◎◎─┘                parameter:amount        parameter:amount        parameter:m
;                   ∨                   body:(if (>=...))       body:(set! ...)         body:(cond (...))
;              parameter:m
;              body:dispatch

; ((acc 'deposit) 40)
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-account:...                                                                                 │
; global -> │acc:...                                                                                          │
; env       │                                                                                                 │
;           └─────────────────────────────────────────────────────────────────────────────────────────────────┘
;                                                                  ∧
;                                    ┌─────────────────────────────────────────────────────────┐
;                                    │balance:50                                               │
;                                    │withdraw:...                                             │
;                              E1 -> │deposit:...                                              │
;                                    │dispatch:...                                             │
;                                    └─────────────────────────────────────────────────────────┘
;                                            ∧                            ∧
;                                    ┌─────────────────┐          ┌────────────┐ 
;                              E2 -> │m:'desposit      │    E3 -> │amount:40   │
;                                    └─────────────────┘          └────────────┘
;                                       (cond (...))        (set! balance (+ balance amount))

; After application
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-account:...                                                                                 │
; global -> │acc:...                                                                                          │
; env       │                                                                                                 │
;           └─────────────────────────────────────────────────────────────────────────────────────────────────┘
;                                                                  ∧
;                                    ┌─────────────────────────────────────────────────────────┐
;                                    │balance:90                                               │
;                                    │withdraw:...                                             │
;                              E1 -> │deposit:...                                              │
;                                    │dispatch:...                                             │
;                                    └─────────────────────────────────────────────────────────┘

; ((acc 'withdraw) 60)
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-account:...                                                                                 │
; global -> │acc:...                                                                                          │
; env       │                                                                                                 │
;           └─────────────────────────────────────────────────────────────────────────────────────────────────┘
;                                                                  ∧
;                                    ┌─────────────────────────────────────────────────────────┐
;                                    │balance:90                                               │
;                                    │withdraw:...                                             │
;                              E1 -> │deposit:...                                              │
;                                    │dispatch:...                                             │
;                                    └─────────────────────────────────────────────────────────┘
;                                            ∧                            ∧
;                                    ┌─────────────────┐          ┌────────────┐ 
;                              E4 -> │m:'withdraw      │    E5 -> │amount:60   │
;                                    └─────────────────┘          └────────────┘
;                                       (cond (...))               (if (>= ...))

; After application
;           ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
;           │make-account:...                                                                                 │
; global -> │acc:...                                                                                          │
; env       │                                                                                                 │
;           └─────────────────────────────────────────────────────────────────────────────────────────────────┘
;                                                                  ∧
;                                    ┌─────────────────────────────────────────────────────────┐
;                                    │balance:30                                               │
;                                    │withdraw:...                                             │
;                              E1 -> │deposit:...                                              │
;                                    │dispatch:...                                             │
;                                    └─────────────────────────────────────────────────────────┘